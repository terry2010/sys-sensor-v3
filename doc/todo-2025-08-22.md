# 2025-08-22 采集器开发计划（当日）

本轮聚焦后端采集器（Collectors）落地与契约对齐，先完成磁盘/网络，GPU/Sensor 维持占位并给出字段与数据源预案。

## 统一开发流程（检查清单）
1) 在本文件写入将要开发的指标（字段、来源、边界）
2) 修改后端代码增加指标采集数据，反复尝试编译直至通过
3) 修改/新增测试代码，反复运行测试直至全部通过
4) 在 Tauri 前端增加相应指标显示，并在主进程中临时打印指标数据
5) 使用 `scripts/dev.ps1` 启动联调，确认程序能启动、打印数据符合预期
6) 注释掉 Tauri 主进程的临时打印代码（恢复为安静模式）
7) 重读 `doc/istat-menus-metrics.md`，确认当前指标实现正确，并选择下一项开发

## 今日目标
- [ ] 实现 DiskCollector（读写速率、队列长度），与文档字段一致，出现异常时安全回退0值。
- [ ] 实现 NetworkCollector（上/下行速率），多网卡汇总；异常与无活动接口回退0值。
- [ ] 对 `snapshot()`、`metrics` 推流与 `query_history` 写入保持兼容（仅 CPU/Memory 持久化，Disk/Net 仅实时展示，后续再评估历史需求）。
- [ ] 单测补齐：字段命名 snake_case、空设备/权限不足回退、速率计算正确性（时间窗差分）。

## 指标定义（与 `doc/istat-menus-metrics.md` 对齐，命名为 snake_case）

- cpu
  - usage_percent: number 0~100（已实现）
- memory
  - total: number MB（已实现）
  - used: number MB（已实现）
- disk（本轮新增，先总览级别，后续可扩展每卷/每物理磁盘）
  - read_bytes_per_sec: number（long）
  - write_bytes_per_sec: number（long）
  - queue_length: number（double，平均队列长度；不可得时返回0）
- network（本轮新增，先全部网卡汇总，后续可按接口细分）
  - up_bytes_per_sec: number（long，上行）
  - down_bytes_per_sec: number（long，下行）
- gpu（占位）
  - usage_percent?: number | null
  - vram_used_mb?: number | null
- sensor（占位）
  - temperatures?: { [key: string]: number } | null（摄氏）
  - fan_rpm?: { [key: string]: number } | null

说明：gpu/sensor 后续接入 NVML/WMI/OHWM，当前返回 null 或空对象，不中断推流。

## 数据来源与实现策略（Windows 10 环境）

- DiskCollector
  - 数据源优先级：
    1) PerformanceCounter ("PhysicalDisk", "Disk Read Bytes/sec"、"Disk Write Bytes/sec"、"Current Disk Queue Length")
    2) 回退：WMI Win32_PerfFormattedData_PerfDisk_PhysicalDisk 聚合
    3) 再回退：返回 0（并打 Debug 日志）
  - 聚合策略：对 "_Total" 计数器读取，避免多实例拼接；未来可扩展 per-instance。
  - 采样节流：Collector 内部缓存上次值/时间戳，若被高频调用，按最小 200ms 间隔复用上次结果。

- NetworkCollector
  - 数据源优先级：
    1) PerformanceCounterCategory("Network Interface") 实例集合，读取 "Bytes Sent/sec"、"Bytes Received/sec" 汇总
    2) 回退：WMI Win32_PerfFormattedData_Tcpip_NetworkInterface 汇总
    3) 再回退：返回 0（并打 Debug 日志）
  - 过滤策略：忽略已断开/环回/虚拟测试接口（名称包含 "Loopback"、"isatap"、"Teredo" 等），后续可配置白名单。
  - 采样节流：同上，最小 200ms 复用。

- GPU（占位）
  - 数据源预案：NVML（NVIDIA）、WDDM/WMI、Vendor SDK；当前返回 null。

- Sensor（占位）
  - 数据源预案：OpenHardwareMonitorLib 或 LibreHardwareMonitor，通过插件式封装；当前返回 null。

## 频率与性能
- 默认推流间隔：继承 `RpcHostedService` 中的 `_baseIntervalMs`（默认 1000ms，最小保护 100ms）；
- Burst 模式：`burst_subscribe` 生效窗口内按更小间隔推送；
- Collector 内部节流：避免读取系统计数器过于频繁（200ms 窗口内复用）。
- 异常容错：计数器创建失败或读取异常返回 0/null，不抛出，记录 Debug 日志。

## 契约与前端影响
- `snapshot()` 与 `metrics` 推流将携带新增字段：`disk`、`network`；前端可直接渲染。
- 历史写入当前仅保留 CPU/Memory（见 `HistoryStore.AppendAsync`），后续视需求对 Disk/Network 增加历史表。
- 模块名别名：输入 `mem` 统一映射为 `memory`（已在 `snapshot()/start()` 处理）。

## 边界与回退
- 无磁盘/无有效网络接口：返回 0 值对象。
- 权限/计数器不可用：返回 0 值对象，并打印一次性 Debug 日志（每种错误按连接/进程限频）。
- 多网卡瞬时峰值：汇总后可能偏大，属设计预期；后续可提供 per-interface 模式。

## 测试计划（当日）
- 单元测试（`SystemMonitor.Tests`）：
  - 字段命名 snake_case 校验（JSON 序列化）
  - Disk/Network 在无可用计数器环境下返回 0（不抛）
  - 人工注入窗口（mock 时间）验证速率随时间递增/复位逻辑
- 端到端（`EndToEndTests`）：
  - `snapshot()` 返回包含 `disk`/`network` 对象
  - `hello` + 事件桥 + `start(['cpu','mem','disk','network'])` 后能收到带新增字段的 `metrics`

## 今日交付
- 提交：
  - 后端：`RpcHostedService` 内 `DiskCollector`、`NetworkCollector` 真实实现（含节流/容错）
  - 测试：新增/更新若干单测覆盖上述场景
  - 文档：本文件与必要的 `doc/api-reference.md` 字段补充（如需）


## CPU 全量指标实现计划与平台映射说明（Windows）

本节对应 `doc/istat-menus-metrics.md` 的 CPU 清单，逐项在 Windows 上给出实现与替代方案。

- 概览与分解
  - usage_percent（已有）：GetSystemTimes 差分
  - user_percent/system_percent/idle_percent：由 GetSystemTimes 的 user/kernel/idle 差分推导（kernel 含 idle，需剔除）
  - per_core[]（每核使用率）：PerformanceCounter("Processor", "% Processor Time", core-instance)，排除 _Total；数组顺序以实例名排序
  - load_avg_1m/5m/15m：Windows 无原生 load average，采用 usage_percent 的 EWMA 近似（α 分别对应窗口大小）
  - process_count/thread_count：PerformanceCounter("System", "Processes"/"Threads") 或回退 API（前者优先）
  - uptime_sec：Environment.TickCount64/1000 或 WMI LastBootUpTime 回退

- 频率/时钟
  - current_mhz/max_mhz：WMI Win32_Processor.CurrentClockSpeed/MaxClockSpeed，失败则返回 null
  - 倍频/Bus：Windows 通常不可直接可靠获取，标注“暂不支持（Windows 不可得）”

- 热/功（交由 sensor 模块）
  - CPU Die/Package/Proximity 温度、包功率/轨功率：放在 `sensor` 模块（OpenHardwareMonitor/LibreHardwareMonitor/NVML 等），CPU 模块不重复实现

- 内核活动（若可用）
  - context_switches/sec、syscalls/sec、interrupts/sec：可映射至 PerformanceCounter("Processor Information"/"System") 若实例与计数器存在；本轮先标注“后续批次接入”（并在实现前再次评估实际稳定性与权限）

不可得/差异说明：
- macOS 特有的 P/E 核分组与部分频率项在 Windows 无直接对应；本项目按 Windows 语义实现，保留字段注释与 TODO。

工作流程对齐（逐指标落实）：
1) 在本文件补充/勾选该指标的字段与来源说明
2) 修改后端：扩展 `RpcHostedService.CpuCollector`（保持 snake_case）
3) 反复编译，直到通过
4) 修改/新增测试并反复运行，直到通过
5) 前端（Tauri）临时在主进程打印该指标并展示
6) 使用 `scripts/dev.ps1` 启动联调，确认打印值合理
7) 注释掉主进程打印
8) 重读 `doc/istat-menus-metrics.md`，选择下一项


## 本次 CPU 指标批次状态（对照“统一开发流程”）
- [x] 在本文件登记 CPU 指标字段与来源（已完成，上文“CPU 全量指标实现计划…”）
- [x] 后端：`RpcHostedService.CpuCollector` 已实现 usage_percent、user/system/idle、uptime_sec、load_avg_1m/5m/15m、process_count、thread_count、per_core、current_mhz/max_mhz
- [x] 编译通过（反复修正后通过）
- [x] 测试：`SystemMonitor.Tests/EndToEndTests.cs` 增加并通过 CPU 字段与范围校验
- [x] 前端：新增 `frontend/src/components/CpuPanel.vue` 展示关键 CPU 指标
- [x] 主进程临时打印：已完成联调并验证日志合理
- [x] 使用 `scripts/dev.ps1` 启动并验证 UI 与日志
- [x] 注释临时打印：已在 `frontend/src-tauri/src/main.rs` 注释 metrics 打印与 3 秒 snapshot 轮询；保留默认订阅（启动即订阅）
- [x] 已重读 `doc/istat-menus-metrics.md`，确认当前 CPU 字段语义与命名；决定下一项见下节

## 下一项：CPU 内核活动计数器（计划）
- 指标：`context_switches_per_sec`、`syscalls_per_sec`、`interrupts_per_sec`
- 数据源（Windows）：
  - 优先：PerformanceCounter("System", "Context Switches/sec"、"System Calls/sec"、"Interrupts/sec") 或相关类别（部分环境可能为 "Processor Information" 聚合）
  - 回退：不可得时返回 null/0，并记录一次性 Debug 日志
- 实现策略：
  - Collector 内部节流与缓存，200ms 窗口复用读取
  - snake_case 命名；加入 `snapshot()` 与 `metrics` 推流
  - 单测覆盖：字段存在性、合理区间（>=0）、不可得回退
- 前端：先在 Snapshot 面板展示；必要时在 CPU 面板添加一行汇总（可选）
- 开发顺序严格遵循“统一开发流程”


## 本次补充登记：CPU 顶部占用进程（Top Processes by CPU%）
- [x] 1) 在本文登记指标字段与来源：`cpu.top_processes[]` → `{ name, pid, cpu_percent }`，差分 `Process.TotalProcessorTime`，按逻辑核数归一，800ms 节流缓存
- [x] 2) 后端实现：`RpcHostedService.CpuCollector` 集成 `TopProcSampler.Instance.Read(5)`，返回 `top_processes`
- [x] 3) 测试补充：`SystemMonitor.Tests/EndToEndTests.cs` 校验 `top_processes` 数组结构与数值范围（0..100）
- [x] 4) 前端展示：`frontend/src/components/CpuPanel.vue` 增加“top processes” 列表（name/CPU%/PID）
- [x] 5) 使用 `scripts/dev.ps1` 启动联调：已验证 UI 与日志正确
- [x] 6) 注释临时打印：保持主进程安静模式（默认订阅保留）
- [x] 7) 文档与契约：`doc/api-reference.md`、`doc/data-models.md` 均已补充 `cpu.top_processes` 说明

