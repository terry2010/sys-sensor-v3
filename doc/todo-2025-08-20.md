# 开发待办清单（2025-08-20）

> 权威任务来源：`doc/task.md`。本清单覆盖今日要产出的设计文档与里程碑1的优先事项。

## 今日目标
- [ ] 产出并提交“实现前必须输出”的设计文档（架构图/JSON-RPC接口规范/数据模型/窗口系统/安全/测试计划/实现计划/补充说明）骨架与首版内容
- [x] 按“里程碑1”建立后端最小可用骨架（控制台形态），可处理 `hello`/`snapshot`（已完成并通过端到端验证）

## 设计文档交付清单（先于实现冻结契约）
- [ ] 系统架构图（组件关系/数据流/部署/窗口关系）
- [x] JSON-RPC接口规范（方法/参数类型/请求响应示例/事件/错误响应/字段snake_case校验）
- [ ] 数据模型设计（指标结构对齐`doc/istat-menus-metrics.md`、SQLite DDL、MMF格式、配置JSON Schema）
- [ ] 窗口系统设计（清单/参数/两窗法细节/动画策略/穿透逻辑）
- [ ] 安全设计（Named Pipe与ACL、Token方案、握手时序、更新签名、最小权限）
- [x] 测试计划（场景/性能基准/覆盖率/CI流程/验收标准）
- [ ] 实现计划（依赖图/开发顺序/风险与验证点/里程碑验收）
- [x] 补充说明（PowerShell示例；调试端口策略；热重载；降级方案；已知限制）

## 里程碑1：后端最小可用骨架（优先实现项）
- [x] 项目结构初始化（`src/SystemMonitor.Service` 与测试工程）
- [x] Named Pipe 服务端 + ACL（仅本机，`\\.\pipe\sys_sensor_v3.rpc`）
- [x] JSON-RPC骨架：`hello`/`snapshot`/`set_config`/`start`/`stop`
- [x] 双形态入口（控制台/服务开关，`--service`）与 CLI 帮助（System.CommandLine）
- [x] Serilog日志与配置热重载（appsettings.json 监听）
- [x] Mock指标生成器（打通UI前先返回稳定Mock）
- [x] 基础单元测试（协议/生命周期），补充 snake_case 正/负用例与 Schema 校验

## 里程碑2：Tauri最小界面（预研与占位）
- [x] Tauri 2.x 单窗口初始化
- [x] Rust pipe 客户端最小实现（或临时Node IPC）
- [x] JSON-RPC客户端封装+自动重连
- [x] 调试窗口：显示连接状态与 `snapshot` 原始JSON

## 执行与验证
- [x] PowerShell 脚本骨架（build.ps1/install-service.ps1/test.ps1）
- [ ] 运行截图与日志采集约定（遇到“cancel”即视为进程已完成，收集日志判断结果）

## 备注
- 字段命名严禁自创，统一以 `doc/istat-menus-metrics.md` 为准（外部snake_case，内部遵循语言习惯，序列化统一转换）。
- 默认不开网络端口，仅使用 Named Pipes；如需临时调试端口须在文档中声明并提供关闭方法。

## 今日进展摘要
- 已实现 JSON-RPC 服务骨架与 Named Pipe ACL；完成 `hello`/`snapshot`/`set_config`/`start`/`stop`。
- 新增模块过滤与速率整形：`set_config` 支持 `module_intervals`，返回 `effective_intervals`，流式 metrics 仅含启用模块。
- CLI 增强：引入 System.CommandLine，新增 `--service` 与内置 `-h/--help`，README 增加帮助示例。
- 契约测试：为所有 JSON-RPC 方法补充 snake_case 正/负用例；新增 JSON Schema 校验与边界值测试。
- 端到端验证完成（EndToEndTests）：
  - 用例1：`hello` 后 `snapshot` 正常返回，字段完整。
  - 用例2：`set_config` 与 `burst_subscribe` 生效，返回 `ok` 与有效 `expires_at`。
- 脚本与产物：`scripts/test.ps1` 产出 `artifacts/test-results/TestResults.trx`；构建与测试全绿。
- 修复编译错误（CS0106），整理 `RpcHostedService.RpcServer` 内部成员与日志。
 - 服务端增强（c1）：`hello` 增加校验与统一错误返回——
   - 校验：`token` 非空、`protocol_version==1`、`capabilities` 必须为支持子集
   - 错误：`UnauthorizedAccessException`（unauthorized）、`NotSupportedException`（not_supported）
   - 日志：结构化输出 `session_id/app_version/protocol_version/capabilities`

## TRX 报告编码与显示巩固（当日专项）
- [x] 清查 `scripts/trx-report.ps1` 是否含非 ASCII 或潜在乱码注释，统一英文注释
- [x] 在 PowerShell 7（pwsh）下生成报告，确认 `index.html` 字符集声明、中文/符号显示正常
- [x] 在 Windows PowerShell 5.1 下生成报告，确认 `index.html` 字符集声明、中文/符号显示正常
- [x] 若仍有差异，记录差异点与 TRX 字段解析（Times/ResultSummary）状况
- [x] 可选：实现 `-Lang`（默认 `en`，支持 `zh-CN`），采用外置 UTF-8 BOM JSON 文案避免源码中文

### 运行命令
```powershell
# PowerShell 7（推荐）
pwsh -NoProfile -ExecutionPolicy Bypass -File .\scripts\trx-report.ps1 -TrxPath "artifacts\test-results\TestResults.trx"

# Windows PowerShell 5.1
powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\trx-report.ps1 -TrxPath "artifacts\test-results\TestResults.trx"
```

### 验证点
- [x] `artifacts/test-results/report/index.html` 头部含 `<meta charset="utf-8">` 与 `http-equiv` 两项
- [x] 文件实际编码为 UTF-8 with BOM
- [x] 标题与统计（Total/Passed/Failed/Skipped）与 TRX 一致
- [x] 时间范围行显示为 `Time Range: <start> -> <finish> (Duration: <duration>)`，无乱码
- [x] 失败用例的 `Message/StackTrace` 中文或符号不乱码（如有）

## 执行记录：TRX 报告生成与打开（2025-08-20 15:31）
__环境__：Windows PowerShell 5.1（powershell.exe）

__英文报告__：
```powershell
powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\trx-report.ps1 `
  -TrxPath "artifacts\test-results\TestResults.trx" `
  -OutDir "artifacts/test-results/report-ps51-en" `
  -Lang en -Open
```
产物：`artifacts/test-results/report-ps51-en/index.html`

__中文报告__：
```powershell
powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\trx-report.ps1 `
  -TrxPath "artifacts\test-results\TestResults.trx" `
  -OutDir "artifacts/test-results/report-ps51-zh" `
  -Lang zh-CN -Open
```
产物：`artifacts/test-results/report-ps51-zh/index.html`

__结果__：两份报告均已在默认浏览器自动打开；页面为 UTF-8 BOM，`<meta charset="utf-8">` 与 `http-equiv` 正常；中文文案（标题、统计、表头、Outcome 徽章“通过/失败/跳过”）显示正常，无乱码。
