# 开发待办清单（2025-08-21）

> 权威任务来源：`doc/task.md`、`doc/api-reference.md`、`doc/architecture.md`。本清单覆盖近期（~3天）的实现与文档完善计划，并与“桌面宠物延期”约束对齐。

## 约束与原则
- 桌面宠物（电子宠物）相关功能延期；当前周期不纳入设计与实现。依据：`doc/task.md`“计划变更（2025-08-21）”。
- 本地启动统一使用 `scripts/dev.ps1`；如需临时命令，请补到脚本内再调用。
  - 窗口范围声明：本周期仅包含“主窗口”，不含任何“桌面宠物/电子宠物”相关窗口与交互。

## 状态快照（截至 2025-08-21 21:15）
- 里程碑2：Tauri 初始化、Rust Pipe 客户端、JSON-RPC 自动重连、最小调试窗口已完成；“设置持久化最小实现（存储与回读）”待验证。
- 里程碑3（部分完成）：
  - 采集器：CPU/Memory 已实现；Disk/Network/GPU/Sensor 未实现。
  - 调度/功耗：仅基础间隔与临时高频（`set_config`/`burst_subscribe`），无状态机。
  - 历史：SQLite 原始表与查询已通；聚合未落地；`query_history` 的 step 为内存分桶。
  - 事件：`metrics` 推流已实现；`state` 事件未实现。
  - 快照/统一接口：`snapshot` 有效，统一抽象待补。
  - 测试：E2E 覆盖主要 RPC；采集器与状态机单测不足。

## 今日目标（EOD）
- [x] 后端：完善 `query_history` 边界/分桶语义（闭区间与右边界对齐），并补齐单点/极小窗口用例。（已实现于 `RpcHostedService.query_history`，含 SQLite 优先、内存回退、空窗即时值）
  - 语义：时间为闭区间 `[from_ts, to_ts]`；`to_ts<=0` 或 `to_ts<from_ts` 时取当前时间。
  - 分桶：`bucket=floor((ts-from)/step_ms)`；返回项 `ts=from+(bucket+1)*step_ms`（右边界对齐）。
  - 空窗回退：若无历史，返回一条“即时值”（字段与实时一致）。
- [x] 后端：实现最小版 `state` 事件（`phase: start|stop|burst`，可选 `reason/extra`），在 `start()/stop()/burst_subscribe()` 成功时各发 1 条。（验收通过：2025-08-22）
- [x] 前端：事件桥断线重连与可观测（toast/事件流），调试页展示 `hello`/`snapshot`/`metrics` 最近 N 条与 `state` 角标。（验收通过：2025-08-22）
- [ ] 文档：`doc/task.md` 标注里程碑3“已完成/部分/未完成”；`doc/api-reference.md` 增加 `state` 事件草案与 `query_history` 边界/分桶说明；补充 `modules` 命名别名（`mem` 输入→对外统一 `memory`）。

## 后端任务（优先级：高→中）
- [ ] 采集器扩展：抽象统一采集接口；新增 Disk（IO 速率/队列长度）、Network（上下行速率）、占位 GPU/Sensor。
- [ ] 历史聚合：设计 10s/1m 聚合表与写入流程；`query_history` 支持聚合级别参数（可留空实现）。
- [x] 事件：实现并推送 `state`（`phase/reason/ts` 最小字段），并在前端订阅展示。（已在 `start/stop/burst_subscribe` 内调用 `EmitState()`）
- [ ]（延期） 配置持久化：落地 `set_config(persist=true)` 的存储与回读；服务启动时应用。（参数存在但尚未落地）
- [ ] 日志与错误：关键路径结构化日志；参数校验与错误码统一。（部分已有校验/日志，仍需统一错误码）


## 前端任务（并行）
- [ ] （延期）`rpc.tauri.ts`：新增 `ensureEventBridge()`（指数退避+可取消），错误 toast/状态事件；暴露订阅切换（复用同一桥接）。
- [ ] 调试视图：展示 `hello` 结果、`snapshot` JSON、`metrics` 最近 N 条；`state` 事件角标/最近一次状态。

## 测试与契约
- [ ] `EndToEndTests.cs`：
  - `state` 流用例：触发 `start/stop/burst` 后收到 1 条事件，字段完整（`phase/ts`）且顺序合理。
  - `query_history` 用例：from==to（单点）、step>(to-from)（单桶）、非整倍数窗口（尾桶右对齐）、空窗回退即时值。
- [ ] 采集器单测：CPU/Memory 采样边界与异常回退（CPU 初次零值、内存 API 失败回退常量）；契约 snake_case 校验。

## 运行与脚本
- [x] 用 `scripts/dev.ps1` 一键拉起服务+前端；如需安装依赖或环境变量，请追加到脚本。（已验证可用）
- [ ] `appsettings.json` 注释：日志级别、基础采集间隔、数据库路径；建议 SQLite 开启 WAL 与 `synchronous=NORMAL`（在 README 标注原理与取舍）。

## 输出物与提交规范（今日）
- 代码：`state` 事件最小实现、`query_history` 边界完善、前端事件桥可观测。
- 文档：`task.md` 标注里程碑3细化状态；`api-reference.md` 增加 `state` 事件草案与错误示例。
- 提交示例：
  - `feat(service): emit state events for lifecycle`
  - `feat(store): query_history step semantics and tests`
  - `feat(frontend): bridge reconnect and debug panel`
  - `docs(task): update milestone3 status`

## EOD 检查清单
- [ ] UI 调试页可看到 `hello` 返回体、`snapshot` JSON、`metrics` 最近 N 条，且 `state` 角标随事件变化。
- [ ] `query_history` 能返回近 1 分钟数据（步长 1s），边界/空窗用例通过。
- [ ] 桥接断线后自动恢复连接并继续推流（有 toast/事件提示）。
- [ ] 合约测试通过；新增 `state/历史边界` 用例落地并稳定。
