# 开发待办清单（2025-08-21）

> 权威任务来源：`doc/task.md`、`doc/api-reference.md`、`doc/architecture.md`。本清单覆盖近期（~3天）的实现与文档完善计划，并与“桌面宠物延期”约束对齐。

## 约束与原则
- 桌面宠物（电子宠物）相关功能延期；当前周期不纳入设计与实现。依据：`doc/task.md`“计划变更（2025-08-21）”。
- 本地启动统一使用 `scripts/dev.ps1`；如需临时命令，请补到脚本内再调用。

## 状态快照（截至 2025-08-21 21:15）
- 里程碑2：Tauri 初始化、Rust Pipe 客户端、JSON-RPC 自动重连、最小调试窗口已完成；“设置持久化最小实现（存储与回读）”待验证。
- 里程碑3（部分完成）：
  - 采集器：CPU/Memory 已实现；Disk/Network/GPU/Sensor 未实现。
  - 调度/功耗：仅基础间隔与临时高频（`set_config`/`burst_subscribe`），无状态机。
  - 历史：SQLite 原始表与查询已通；聚合未落地；`query_history` 的 step 为内存分桶。
  - 事件：`metrics` 推流已实现；`state` 事件未实现。
  - 快照/统一接口：`snapshot` 有效，统一抽象待补。
  - 测试：E2E 覆盖主要 RPC；采集器与状态机单测不足。

## 今日目标（EOD）
- [ ] 后端：完善 `query_history` 边界语义（空窗回退已有；补充 step==null 与极小窗口测试）。
- [ ] 后端：实现 `state` 事件的最小版本（start/stop/burst 生命周期播报）。
- [ ] 前端：事件桥断线重连可观测（UI 提示+自动恢复），调试页每秒显示 `snapshot` 或 `metrics`。
- [ ] 文档：在 `doc/task.md` 里程碑3清单标注“已完成/部分/未完成”的细化注释；`api-reference.md` 增加 `state` 事件条目草案。

## 后端任务（优先级：高→中）
- [ ] 采集器扩展：抽象统一采集接口；新增 Disk（IO 速率/队列长度）、Network（上下行速率）、占位 GPU/Sensor。
- [ ] 历史聚合：设计 10s/1m 聚合表与写入流程；`query_history` 支持聚合级别参数（可留空实现）。
- [ ] 事件：实现并推送 `state`（含字段：phase、reason、ts），并在前端订阅展示。
- [ ] 配置持久化：落地 `set_config(persist=true)` 的存储与回读；服务启动时应用。
- [ ] 日志与错误：关键路径结构化日志；参数校验与错误码统一。

## 前端任务（并行）
- [ ] `rpc.tauri.ts`：`ensureEventBridge()` 指数退避重连；超时与取消；错误 toast。
- [ ] 调试视图：展示 hello 结果、snapshot JSON、metrics 最近 N 条；事件状态角标。
- [ ] 设置视图：`persist` 开关与实际回读显示（依赖后端落地后验证）。

## 测试与契约
- [ ] `EndToEndTests.cs`：补充 `state` 事件流用例、`query_history` step 边界用例。
- [ ] 采集器单测：CPU/Memory 采样函数边界与异常回退；接口契约 snake_case 校验。

## 运行与脚本
- [ ] 用 `scripts/dev.ps1` 一键拉起服务+前端；如需安装依赖或环境变量，请追加到脚本。
- [ ] `appsettings.json` 注释：日志级别、基础采集间隔、数据库路径与 WAL。

## 输出物与提交规范（今日）
- 代码：`state` 事件最小实现、`query_history` 边界完善、前端事件桥可观测。
- 文档：`task.md` 标注里程碑3细化状态；`api-reference.md` 增加 `state` 事件草案与错误示例。
- 提交示例：
  - `feat(service): emit state events for lifecycle`
  - `feat(store): query_history step semantics and tests`
  - `feat(frontend): bridge reconnect and debug panel`
  - `docs(task): update milestone3 status`

## EOD 检查清单
- [ ] UI 调试页可看到 `hello` 与 `snapshot` 数据
- [ ] `query_history` 可返回近 1 分钟数据（步长 1s）
- [ ] 断线后自动恢复连接并继续推流
 - [ ] 合约测试全部通过；新增/调整用例已落地
