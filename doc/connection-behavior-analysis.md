# 连接行为分析 - 短连接vs长连接

## 问题解答

您看到的每秒出现的连接建立和断开日志**是正常现象**，这是系统设计的一部分。

## 连接类型说明

### 1. 短连接（正常）- 用于RPC调用
这些是您在日志中看到的大部分连接：

```
2025-08-25 05:56:35.593 +08:00 [INF] 客户端已连接
2025-08-25 05:56:35.593 +08:00 [INF] 客户端会话建立: conn="4408485d-ca68-4882-9114-d2571fce2a23"
2025-08-25 05:56:35.609 +08:00 [INF] 客户端断开：已达到流的结尾。 conn="4408485d-ca68-4882-9114-d2571fce2a23"
```

**特征:**
- 连接时长通常 50-1000ms
- 用于执行具体的RPC方法调用
- 调用完成后立即断开
- "已达到流的结尾" 是正常的断开原因

**用途:**
- `snapshot` 调用 - 获取当前系统状态
- `set_config` 调用 - 配置更新
- `start/stop` 调用 - 启动/停止监控模块
- 心跳检查 - 前端定期验证后端可用性

### 2. 长连接 - 用于事件推送
这些连接持续时间较长，用于实时数据推送：

**特征:**
- 连接时长可达分钟或小时级别
- 用于 `metrics` 事件的实时推送
- 在 `hello` 握手时声明 `capabilities: ["metrics_stream"]`
- 断开通常因为网络问题或服务重启

## 日志级别优化

我已经优化了日志输出，现在：

### Information级别（默认显示）
- 异常短连接（<50ms）- 可能有问题
- 长连接的建立和断开
- 关键系统事件

### Debug级别（需要手动启用）
- 正常短连接（50-1000ms）
- 详细的连接诊断信息
- JSON-RPC协议细节

### Warning级别
- 真正的问题连接
- 异常情况和错误

## 如何启用详细日志

如果您需要看到所有连接细节，可以临时将日志级别改为Debug：

1. **修改 appsettings.json:**
```json
{
  "Serilog": {
    "MinimumLevel": {
      "Default": "Debug"
    }
  }
}
```

2. **或者通过环境变量:**
```powershell
$env:Serilog__MinimumLevel__Default = "Debug"
```

## 正常vs异常连接判断

### ✅ 正常情况
- 每秒1-5个短连接（50-1000ms）
- 连接原因: "已达到流的结尾"
- 无异常错误信息
- 伴随有长连接进行事件推送

### ⚠️ 需要关注的情况
- 连接时长 < 50ms（异常短连接）
- 连接失败错误
- 权限拒绝错误
- 大量连接但无长连接

### 🚨 异常情况
- 连接完全失败
- 权限错误
- 网络连接问题
- 服务崩溃

## 连接频率说明

正常情况下您会看到：
- **每30秒**: 前端心跳调用（健康检查）
- **每1秒**: metrics事件推送（通过长连接）
- **按需**: 用户操作触发的RPC调用

## 总结

您看到的日志是**完全正常的**，表明：
1. 前端正在正常工作
2. RPC通信正常
3. 事件桥连接正常
4. 系统运行健康

这种短连接模式是Windows Named Pipe + JSON-RPC架构的标准设计模式，确保了：
- 资源高效利用
- 连接可靠性
- 错误隔离
- 系统稳定性

如果您想减少日志噪音，当前的优化已经将正常的短连接日志降级到Debug级别，只有真正需要关注的问题才会在Information级别显示。