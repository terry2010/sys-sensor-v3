# TODO（2025-08-23）— 网络指标全量实现与对齐

本日目标：基于 `doc/network-metrics-plan.md` 落实网络模块所有指标，与 `doc/istat-menus-metrics.md` 第5节逐项对齐，补齐差异并完成阶段性实现与测试。

---

## 一、与 iStat 清单对照的差异与补齐项

- 差异/遗漏：
  - per-interface 用量统计缺失（iStat: 当日/周/月/计费周期可按接口）：
    - 需在 `usage_totals` 基础上新增 `per_interface_usage[]`：`{ if_id, today_rx_bytes, today_tx_bytes, week_*, month_*, billing_* }`
  - 接口累计丢包计数（drops）在 `per_interface_info` 未覆盖：
    - 已有 `rx_errors/tx_errors/collisions`，补充 `rx_drops`、`tx_drops`（若可读）
  - 其余项与语义：对齐良好（速率/总量、错误/碰撞、Wi‑Fi 详情、以太网速率/双工、虚拟接口、连通性（公网 IP、Ping）、进程榜）。
  - 进度补充：已在阶段 A 中实现 totals 与 per-interface 的 packets/errors/drops 每秒速率（来源：Performance Counters）。

- 命名与单位：保持 snake_case；速率：`*_per_sec`；字节累计：`*_bytes`；速率单位：B/s；链路速率：Mbps。

---

## 二、分阶段开发计划（A→E）

- 阶段 A：实时速率与总览（高优先级）
  - [x] 扩展 `NetCounters`：Bytes/Packets/sec、Errors/sec、Drops/sec（全接口与 per-interface），200ms 节流
  - [x] `NetworkCollector` 输出：`io_totals`、`per_interface_io[]`（含 `utilization_percent`）
  - [ ] 合约/契约测试：字段名/可空性
  - [x] 前端：临时在面板打印 totals 与 per-interface 速率（含 packets/errors/drops）

- 阶段 B：接口静态与累计计数
  - [ ] `NetworkQuery`（IP Helper + WMI/CIM）：`per_interface_info[]`（type/status/mac/mtu/ip/gw/dns/search_domains/errors/drops/collisions）
  - [ ] 以太网扩展：`per_ethernet_info[]`（link_speed_mbps/duplex/auto_negotiation）
  - [ ] 测试：静态字段类型正确、异常回退为 null

- 阶段 C：Wi‑Fi 详情（可用则启用）
  - [ ] WLAN API 读取：`wifi_info` 字段全集
  - [ ] 回退：`netsh wlan show interfaces` 解析（可禁用）
  - [ ] 测试：有/无无线网卡场景

- 阶段 D：连通性与用量
  - [ ] `connectivity`：公网 IP（限流）、`last_changed_ts`，`ping_targets[]`（rtt/jitter/loss）
  - [ ] 用量统计：`usage_totals` 与新增 `per_interface_usage[]`，启动恢复与 SQLite 持久化
  - [ ] E2E：UI 展示速率与接口状态，曲线稳定

- 阶段 E：进程榜（增强）
  - [ ] ETW 订阅聚合：`top_processes_by_network[]`（rx/tx B/s）
  - [ ] 权限/回退：不可用则字段缺省/为空数组

---

## 三、具体任务清单

- 后端采集与模型
  - [x] 扩展现有 `Services/Collectors/NetCounters.cs`：统一抓取实例化的 "Network Interface" 计数器，含缓存与异常回退
  - [ ] 新建 `Services/Queries/NetworkQuery.cs`：聚合 IP Helper/WMI，缓存 30–60s 或事件触发刷新
  - [ ] 新建/完善 `Services/Collectors/NetworkCollector.cs`：组装 payload（A→E 分阶段返回）
  - [ ] 更新 `MetricsRegistry` 注册顺序确认（已包含 `NetworkCollector`）
  - [ ] `HistoryStore`：扩展网络速率持久化（总览/可选 per-interface），用量滚动窗口与恢复

- 合约与测试
  - [ ] 新增契约测试：对 `network` 模块 JSON Schema 校验
  - [ ] 单测：计数器回退（无 PerfCounter 环境）应返回 0/null，无抛出
  - [ ] 聚合校验：`sum(per_interface_io) ≈ io_totals`（误差阈值）
  - [ ] Wi‑Fi/以太网/虚拟接口：字段可用性与类型测试
  - [ ] E2E：`metrics` 通知字段完整性与数值范围

- 前端与桥接
  - [ ] Tauri 事件桥：调试日志打印 network 段，失败事件可视化
  - [ ] Vue 面板：临时表格展示 totals 与 per-interface 速率与状态
  - [ ] 订阅控制：按模块开关 `network`（默认启用）

---

## 四、里程碑与验收

- 里程碑 1（阶段 A 完成）：实时速率 + 合约测试 + 简易 UI
- 里程碑 2（阶段 B 完成）：接口静态信息可读 + E2E 验证
- 里程碑 3（阶段 C/D 完成）：Wi‑Fi 详情、连通性、用量统计与持久化
- 里程碑 4（阶段 E 完成）：进程榜（可选）

---

## 五、运行与调试

- 启动：`./scripts/dev.ps1`（前后端联调，默认订阅 network）
- 故障注入：`SIM_METRICS_ERROR`（观测推送失败恢复）
- 日志：`logs/`（服务端/前端）
